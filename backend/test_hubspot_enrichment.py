#!/usr/bin/env python3
"""
Script de prueba espec√≠fico para la funcionalidad de enriquecimiento con HubSpot
"""

import requests
import json
import os
from dotenv import load_dotenv

# Cargar variables de entorno
load_dotenv()

# Configuraci√≥n
BACKEND_URL = "http://localhost:5003"

def test_hubspot_contact_lookup():
    """Prueba la consulta de informaci√≥n de contacto en HubSpot"""
    
    print("üß™ PRUEBA DE CONSULTA DE CONTACTO EN HUBSPOT")
    print("=" * 60)
    
    # Email de prueba (debe existir en HubSpot)
    test_email = "juan.perez@techcorp.com"
    
    try:
        # Verificar que el servidor est√© funcionando
        health_response = requests.get(f"{BACKEND_URL}/health")
        if health_response.status_code != 200:
            print("‚ùå Servidor backend no est√° respondiendo")
            return False
        
        print(f"üìß Consultando informaci√≥n para: {test_email}")
        
        # Simular una consulta directa a la funci√≥n de HubSpot
        # Nota: En un entorno real, esto requerir√≠a un endpoint espec√≠fico
        # Por ahora, usaremos el endpoint de enriquecimiento completo
        test_data = {
            "emailCorporativo": test_email
        }
        
        response = requests.post(
            f"{BACKEND_URL}/api/enrich-prospect",
            headers={"Content-Type": "application/json"},
            json=test_data
        )
        
        print(f"üìä Status Code: {response.status_code}")
        
        if response.status_code == 200:
            response_data = response.json()
            print("‚úÖ Consulta exitosa")
            
            # Verificar datos de HubSpot
            hubspot_data = response_data.get('hubspot_contact_data')
            if hubspot_data:
                print("\nüìã INFORMACI√ìN DE CONTACTO ENCONTRADA:")
                print("-" * 50)
                
                hubspot_contact = hubspot_data.get('hubspot_data', {})
                contact_info = hubspot_contact.get('contact_info', {})
                
                if contact_info:
                    contact_basic = contact_info.get('informacion_basica', {})
                    print(f"ID de Contacto: {contact_basic.get('id', 'N/A')}")
                    print(f"Nombre: {contact_basic.get('nombre', 'N/A')}")
                    print(f"Email: {contact_basic.get('email', 'N/A')}")
                    print(f"Empresa: {contact_basic.get('empresa', 'N/A')}")
                    print(f"Cargo: {contact_basic.get('cargo', 'N/A')}")
                    print(f"Tel√©fono: {contact_basic.get('telefono', 'N/A')}")
                    
                    # Actividad
                    activity = contact_info.get('actividad', {})
                    print(f"\nüìÖ ACTIVIDAD:")
                    print(f"Fecha de creaci√≥n: {activity.get('fecha_creacion', 'N/A')}")
                    print(f"√öltima modificaci√≥n: {activity.get('ultima_modificacion', 'N/A')}")
                    print(f"√öltima actividad: {activity.get('ultima_actividad', 'N/A')}")
                    print(f"√öltimo contacto: {activity.get('ultimo_contacto', 'N/A')}")
                    
                    # Anal√≠ticas
                    analytics = contact_info.get('analiticas', {})
                    print(f"\nüìä ANAL√çTICAS:")
                    print(f"Fuente: {analytics.get('fuente', 'N/A')}")
                    print(f"N√∫mero de visitas: {analytics.get('num_visitas', 'N/A')}")
                    print(f"P√°ginas vistas: {analytics.get('num_paginas_vistas', 'N/A')}")
                    print(f"√öltima visita: {analytics.get('ultima_visita', 'N/A')}")
                    
                    # Estado
                    estado = contact_info.get('estado', {})
                    print(f"\nüéØ ESTADO:")
                    print(f"Estado del lead: {estado.get('estado_lead', 'N/A')}")
                    print(f"Etapa del ciclo: {estado.get('etapa_ciclo_vida', 'N/A')}")
                    print(f"Puntaje de lead: {estado.get('puntaje_lead', 'N/A')}")
                
                # Engagements
                engagements = hubspot_contact.get('engagements', [])
                if engagements:
                    print(f"\nüìû ENGAGEMENTS ENCONTRADOS: {len(engagements)}")
                    print("-" * 30)
                    
                    # Contar por tipo
                    meeting_count = len([e for e in engagements if e.get('tipo') == 'MEETING'])
                    call_count = len([e for e in engagements if e.get('tipo') == 'CALL'])
                    email_count = len([e for e in engagements if e.get('tipo') == 'EMAIL'])
                    task_count = len([e for e in engagements if e.get('tipo') == 'TASK'])
                    note_count = len([e for e in engagements if e.get('tipo') == 'NOTE'])
                    
                    print(f"üìÖ Reuniones: {meeting_count}")
                    print(f"üìû Llamadas: {call_count}")
                    print(f"üìß Emails: {email_count}")
                    print(f"‚úÖ Tareas: {task_count}")
                    print(f"üìù Notas: {note_count}")
                    
                    # Mostrar los √∫ltimos 3 engagements
                    print(f"\nüïí √öLTIMOS ENGAGEMENTS:")
                    for i, engagement in enumerate(engagements[:3], 1):
                        print(f"  {i}. {engagement.get('tipo', 'N/A')} - {engagement.get('timestamp', 'N/A')}")
                        if engagement.get('titulo'):
                            print(f"     T√≠tulo: {engagement['titulo']}")
                        if engagement.get('asunto'):
                            print(f"     Asunto: {engagement['asunto']}")
                else:
                    print("\nüìû No se encontraron engagements")
                
                # Informaci√≥n de la empresa
                company_info = hubspot_contact.get('company_info', {})
                if company_info:
                    company_details = company_info.get('company_details', {})
                    if company_details:
                        print(f"\nüè¢ INFORMACI√ìN DE EMPRESA EN HUBSPOT:")
                        print("-" * 40)
                        
                        company_basic = company_details.get('informacion_basica', {})
                        print(f"ID de Empresa: {company_basic.get('id', 'N/A')}")
                        print(f"Nombre: {company_basic.get('nombre', 'N/A')}")
                        print(f"Dominio: {company_basic.get('dominio', 'N/A')}")
                        print(f"Industria: {company_basic.get('industria', 'N/A')}")
                        print(f"Sitio web: {company_basic.get('sitio_web', 'N/A')}")
                        
                        # Informaci√≥n financiera
                        financial_info = company_details.get('informacion_financiera', {})
                        if financial_info:
                            print(f"\nüí∞ INFORMACI√ìN FINANCIERA:")
                            print(f"N√∫mero de empleados: {financial_info.get('num_empleados', 'N/A')}")
                            print(f"Ingresos anuales: {financial_info.get('ingresos_anuales', 'N/A')}")
                            print(f"Ingresos totales: {financial_info.get('ingresos_totales', 'N/A')}")
                        
                        # Negocios
                        deals = company_info.get('deals', [])
                        if deals:
                            print(f"\nüíº NEGOCIOS ENCONTRADOS: {len(deals)}")
                            for i, deal in enumerate(deals[:3], 1):
                                deal_basic = deal.get('informacion_basica', {})
                                print(f"  {i}. {deal_basic.get('nombre', 'N/A')}")
                                print(f"     Monto: {deal_basic.get('monto', 'N/A')}")
                                print(f"     Etapa: {deal_basic.get('etapa', 'N/A')}")
                                print(f"     Fecha de cierre: {deal_basic.get('fecha_cierre', 'N/A')}")
                        else:
                            print("\nüíº No se encontraron negocios")
                    else:
                        print("\nüè¢ No se encontr√≥ informaci√≥n de empresa")
                else:
                    print("\nüè¢ No se encontr√≥ informaci√≥n de empresa")
                
                return True
            else:
                print("‚ö†Ô∏è No se encontraron datos de HubSpot")
                print("Esto puede significar que:")
                print("- El contacto no existe en HubSpot")
                print("- La API Key no tiene permisos suficientes")
                print("- Hay un error en la configuraci√≥n")
                return False
        else:
            print("‚ùå Error en la consulta")
            print(f"Response: {response.text}")
            return False
            
    except requests.exceptions.ConnectionError:
        print("‚ùå Error: No se puede conectar al servidor backend")
        print("üí° Aseg√∫rate de que el servidor est√© ejecut√°ndose en el puerto 5003")
        return False
    except Exception as e:
        print(f"‚ùå Error inesperado: {str(e)}")
        return False

def test_hubspot_configuration():
    """Verifica la configuraci√≥n de HubSpot"""
    
    print("üîß VERIFICANDO CONFIGURACI√ìN DE HUBSPOT")
    print("=" * 50)
    
    hubspot_key = os.getenv('HUBSPOT_API_KEY')
    hubspot_portal = os.getenv('HUBSPOT_PORTAL_ID')
    
    if hubspot_key:
        print("‚úÖ HUBSPOT_API_KEY configurada")
        print(f"   Key: {hubspot_key[:10]}...{hubspot_key[-4:]}")
    else:
        print("‚ùå HUBSPOT_API_KEY no configurada")
    
    if hubspot_portal:
        print("‚úÖ HUBSPOT_PORTAL_ID configurado")
        print(f"   Portal ID: {hubspot_portal}")
    else:
        print("‚ùå HUBSPOT_PORTAL_ID no configurado")
    
    if not hubspot_key or not hubspot_portal:
        print("\nüí° Para configurar HubSpot:")
        print("1. Ve a Settings > Integrations > Private Apps en HubSpot")
        print("2. Crea una nueva Private App con los permisos necesarios")
        print("3. Copia el API Key generado")
        print("4. Obt√©n el Portal ID desde Settings > Account Setup")
        print("5. Agrega las variables al archivo .env")
    
    print("-" * 50)
    return bool(hubspot_key and hubspot_portal)

def test_contact_creation_and_lookup():
    """Prueba crear un contacto y luego consultarlo"""
    
    print("\nüîÑ PRUEBA DE CREACI√ìN Y CONSULTA DE CONTACTO")
    print("=" * 60)
    
    # Datos de prueba para crear contacto
    test_contact_data = {
        "nombres": "Mar√≠a",
        "apellidos": "Gonz√°lez Test",
        "compania": "Test Company",
        "websiteUrl": "https://www.testcompany.com",
        "emailCorporativo": "maria.gonzalez@testcompany.com",
        "rol": "Gerente de Ventas"
    }
    
    try:
        # Crear contacto
        print("üìù Creando contacto de prueba...")
        create_response = requests.post(
            f"{BACKEND_URL}/api/prospect",
            headers={"Content-Type": "application/json"},
            json=test_contact_data
        )
        
        if create_response.status_code == 200:
            create_data = create_response.json()
            print("‚úÖ Contacto creado exitosamente")
            print(f"   HubSpot ID: {create_data.get('hubspot_id', 'N/A')}")
            
            # Esperar un momento para que se propague
            import time
            print("‚è≥ Esperando propagaci√≥n de datos...")
            time.sleep(2)
            
            # Consultar el contacto reci√©n creado
            print("\nüîç Consultando contacto reci√©n creado...")
            lookup_data = {"emailCorporativo": test_contact_data["emailCorporativo"]}
            
            lookup_response = requests.post(
                f"{BACKEND_URL}/api/enrich-prospect",
                headers={"Content-Type": "application/json"},
                json=lookup_data
            )
            
            if lookup_response.status_code == 200:
                lookup_result = lookup_response.json()
                hubspot_success = lookup_result.get('enrichment_summary', {}).get('hubspot_success', False)
                
                if hubspot_success:
                    print("‚úÖ Contacto encontrado y consultado exitosamente")
                    return True
                else:
                    print("‚ö†Ô∏è Contacto creado pero no se pudo consultar inmediatamente")
                    print("   Esto puede ser normal debido a la propagaci√≥n de datos")
                    return True
            else:
                print("‚ùå Error consultando contacto reci√©n creado")
                return False
        else:
            print("‚ùå Error creando contacto")
            print(f"Response: {create_response.text}")
            return False
            
    except Exception as e:
        print(f"‚ùå Error inesperado: {str(e)}")
        return False

if __name__ == "__main__":
    print("üöÄ PRUEBAS DE ENRIQUECIMIENTO CON HUBSPOT")
    print("=" * 80)
    
    # Verificar configuraci√≥n
    config_ok = test_hubspot_configuration()
    
    if not config_ok:
        print("\n‚ùå Configuraci√≥n incompleta. Revisa las variables de entorno.")
        exit(1)
    
    # Ejecutar pruebas
    print("\n")
    test1_passed = test_hubspot_contact_lookup()
    test2_passed = test_contact_creation_and_lookup()
    
    print("\n" + "=" * 80)
    print("üìä RESUMEN DE PRUEBAS")
    print("=" * 80)
    print(f"‚úÖ Configuraci√≥n HubSpot: {'OK' if config_ok else 'FALLO'}")
    print(f"‚úÖ Consulta de contacto: {'PAS√ì' if test1_passed else 'FALL√ì'}")
    print(f"‚úÖ Creaci√≥n y consulta: {'PAS√ì' if test2_passed else 'FALL√ì'}")
    
    if config_ok and test1_passed and test2_passed:
        print("\nüéâ ¬°Todas las pruebas de HubSpot pasaron exitosamente!")
        print("üîó La integraci√≥n con HubSpot est√° funcionando correctamente")
    else:
        print("\n‚ùå Algunas pruebas fallaron. Revisa los logs arriba.")
        if not config_ok:
            print("üí° Configura las variables de entorno de HubSpot primero")
